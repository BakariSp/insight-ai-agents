# æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ

> Insight AI Agent ä¸‰æ–¹åè°ƒæ¶æ„ä¼˜åŒ–è®¾è®¡ (Phase 6+ å‰ç«¯é›†æˆå‡†å¤‡)

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-02-04
**ç›®æ ‡è¯»è€…**: ç³»ç»Ÿæ¶æ„å¸ˆã€å‰ç«¯å›¢é˜Ÿã€Java åç«¯å›¢é˜Ÿã€Python åç«¯å›¢é˜Ÿ

---

## æ‰§è¡Œæ‘˜è¦

### å½“å‰çŠ¶æ€ (Phase 7 å®Œæˆ)

âœ… **å·²å®Œæˆ**:
- Python FastAPI åç«¯: å®Œæ•´çš„ AI Agent æµæ°´çº¿ (Router â†’ Planner â†’ Executor)
- Java åç«¯å¯¹æ¥: Adapter å±‚ + httpx å®¢æˆ·ç«¯ (é‡è¯• + ç†”æ–­ + é™çº§)
- SSE æµå¼åè®®: BLOCK_START/SLOT_DELTA/BLOCK_COMPLETE é€ block äº‹ä»¶
- Patch æœºåˆ¶: å¢é‡ä¿®æ”¹é¿å…å…¨é¡µé‡å»º
- RAG çŸ¥è¯†åº“: é¢˜ç›®ç”Ÿæˆå·²æ¥å…¥è¯¾çº²/Rubric/çŸ¥è¯†ç‚¹

ğŸ”² **å¾…å®Œæˆ**:
- å‰ç«¯é›†æˆ (Next.js proxy + SSE æ¶ˆè´¹)
- ä¸‰æ–¹ API ç‰ˆæœ¬ç®¡ç†å’Œå˜æ›´åè°ƒæœºåˆ¶
- ç»Ÿä¸€çš„ç›‘æ§å’Œæ€§èƒ½æŒ‡æ ‡

### æ ¸å¿ƒé—®é¢˜

1. **ä¸‰æ–¹åè°ƒèŒè´£æ¨¡ç³Š**: Java â†” Python â†” å‰ç«¯ï¼Œç¼ºä¹æ¸…æ™°å¥‘çº¦
2. **æ•°æ®æµå‘ä¸æ˜ç¡®**: å¤šæ¬¡æ ¼å¼è½¬æ¢ (Java DTO â†’ Internal Model â†’ TypeScript)
3. **é”™è¯¯å¤„ç†é“¾è·¯ä¸å®Œæ•´**: Java é”™è¯¯ â†’ Python â†’ SSE â†’ å‰ç«¯ï¼Œç¼ºä¹ç»Ÿä¸€è§„èŒƒ
4. **Phase 8 å‡çº§è·¯å¾„ä¸æ¸…æ™°**: å¦‚ä½•å¹³æ»‘è¿‡æ¸¡åˆ°é€šç”¨çŸ¥è¯†å±‚ï¼Ÿ

### ä¼˜åŒ–ç›®æ ‡

1. **æ˜ç¡®ä¸‰å±‚èŒè´£è¾¹ç•Œ**: å‰ç«¯å±‚ / AI ç¼–æ’å±‚ / æ•°æ®æœåŠ¡å±‚
2. **ç»Ÿä¸€æ•°æ®å¥‘çº¦**: å‡å°‘è½¬æ¢å±‚æ¬¡ï¼Œè‡ªåŠ¨ç”Ÿæˆ TypeScript ç±»å‹
3. **å®Œå–„é”™è¯¯å¤„ç†é“¾è·¯**: Java â†’ Python â†’ SSE â†’ å‰ç«¯ï¼Œå…¨é“¾è·¯é”™è¯¯ç æ˜ å°„
4. **å»ºç«‹æ€§èƒ½ SLA**: å“åº”æ—¶é—´ã€å¹¶å‘ã€ç¼“å­˜ç­–ç•¥
5. **è§„åˆ’ Phase 8 å‡çº§**: é€šç”¨çŸ¥è¯†å±‚æ¶æ„å¹³æ»‘è¿‡æ¸¡

---

## æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä¸‰å±‚èŒè´£æ¸…æ™°åŒ–

#### 1.1 æ¶æ„å…¨æ™¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å‰ç«¯å±‚ (Next.js)                              â”‚
â”‚  èŒè´£: UI æ¸²æŸ“ + ç”¨æˆ·äº¤äº’ + SSE æ¶ˆè´¹ + å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç†                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ ¸å¿ƒèƒ½åŠ›:                                                            â”‚
â”‚  - API Routes Proxy: /api/ai/* â†’ Python FastAPI                     â”‚
â”‚  - SSE EventSource: å®æ—¶æ¶ˆè´¹ Python SSE æµ                           â”‚
â”‚  - State Management: Blueprint/Page/Context ç¼“å­˜                    â”‚
â”‚  - Component Rendering: 6 ç§ Block ç±»å‹æ¸²æŸ“                          â”‚
â”‚  - Error Boundary: ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¦æ­¢ç›´æ¥è°ƒç”¨:                                                        â”‚
â”‚  âŒ Java åç«¯ API (å¿…é¡»é€šè¿‡ Python ç¼–æ’å±‚)                            â”‚
â”‚  âŒ ç›´æ¥æ“ä½œ LLM API (å¿…é¡»é€šè¿‡ Python Agent)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ HTTP/SSE
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AI ç¼–æ’å±‚ (Python FastAPI)                         â”‚
â”‚  èŒè´£: æ„å›¾ç†è§£ + Blueprint ç”Ÿæˆ + é¡µé¢ç¼–æ’ + RAG æ£€ç´¢               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ ¸å¿ƒ Agents:                                                        â”‚
â”‚  - RouterAgent: æ„å›¾åˆ†ç±» (chat/build/clarify/refine/rebuild)         â”‚
â”‚  - EntityResolver: ç­çº§/å­¦ç”Ÿ/ä½œä¸šå®ä½“è§£æ                            â”‚
â”‚  - PlannerAgent: user prompt â†’ Blueprint (ç»“æ„åŒ–æ‰§è¡Œè®¡åˆ’)            â”‚
â”‚  - ExecutorAgent: Blueprint â†’ Page (ä¸‰é˜¶æ®µæµå¼æ‰§è¡Œ)                  â”‚
â”‚  - PatchAgent: å¢é‡ä¿®æ”¹åˆ†æ (layout/compose/rebuild)                 â”‚
â”‚  - QuestionPipeline: Draftâ†’Judgeâ†’Repair é¢˜ç›®ç”Ÿæˆæµæ°´çº¿               â”‚
â”‚                                                                       â”‚
â”‚  å·¥å…·å±‚ (FastMCP):                                                   â”‚
â”‚  - DataTools: get_teacher_classes / get_class_detail / ...          â”‚
â”‚  - StatsTools: calculate_stats / compare_performance                â”‚
â”‚  - AssessmentTools: analyze_student_weakness                         â”‚
â”‚  - RubricTools: get_rubric                                          â”‚
â”‚  - RAG: retrieve_curriculum / retrieve_knowledge_points (Phase 7)   â”‚
â”‚                                                                       â”‚
â”‚  Adapter å±‚:                                                         â”‚
â”‚  - class_adapter / submission_adapter / grade_adapter               â”‚
â”‚  - Java DTO â†’ Internal Data Model è½¬æ¢                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¯¹ä¸Šæ¥å£: ç»Ÿä¸€ä¼šè¯ç½‘å…³ POST /api/conversation                        â”‚
â”‚  å¯¹ä¸‹æ¥å£: Java RESTful API (via httpx + retry + circuit breaker)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¦æ­¢ç›´æ¥æ“ä½œ:                                                        â”‚
â”‚  âŒ æ•°æ®åº“ç›´æ¥è¯»å†™ (å¿…é¡»é€šè¿‡ Java åç«¯)                               â”‚
â”‚  âŒ å‰ç«¯ UI é€»è¾‘ (åªè´Ÿè´£æ•°æ®å’Œ AI ç¼–æ’)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ HTTP + Bearer Token
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®æœåŠ¡å±‚ (Java SpringBoot)                       â”‚
â”‚  èŒè´£: æ•™åŠ¡æ•°æ® CRUD + æƒé™æ§åˆ¶ + ä¸šåŠ¡è§„åˆ™                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ ¸å¿ƒèŒè´£:                                                            â”‚
â”‚  - æ•°æ®æŒä¹…åŒ–: ç­çº§/å­¦ç”Ÿ/ä½œä¸š/æˆç»© CRUD                               â”‚
â”‚  - æƒé™éªŒè¯: æ•™å¸ˆåªèƒ½è®¿é—®è‡ªå·±çš„ç­çº§æ•°æ®                               â”‚
â”‚  - ä¸šåŠ¡è§„åˆ™: ä½œä¸šæäº¤æˆªæ­¢æ—¶é—´ã€æˆç»©è®¡ç®—è§„åˆ™                           â”‚
â”‚  - æ•°æ®æ ¡éªŒ: è¾“å…¥å‚æ•°åˆæ³•æ€§æ ¡éªŒ                                       â”‚
â”‚                                                                       â”‚
â”‚  æä¾› RESTful API:                                                   â”‚
â”‚  - GET /dify/teacher/{id}/classes/me                                â”‚
â”‚  - GET /dify/teacher/{id}/classes/{classId}                         â”‚
â”‚  - GET /dify/teacher/{id}/classes/{classId}/assignments             â”‚
â”‚  - GET /dify/teacher/{id}/submissions/assignments/{assignmentId}    â”‚
â”‚  - GET /dify/teacher/{id}/submissions/students/{studentId}          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¦æ­¢ç›´æ¥æš´éœ²:                                                        â”‚
â”‚  âŒ ç›´æ¥æš´éœ²ç»™å‰ç«¯ (å¿…é¡»é€šè¿‡ Python ç¼–æ’å±‚)                           â”‚
â”‚  âŒ åŒ…å« AI é€»è¾‘ (åªè´Ÿè´£æ•°æ®å’Œä¸šåŠ¡è§„åˆ™)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.2 èŒè´£çŸ©é˜µ

| èŒè´£ | å‰ç«¯ Next.js | Python FastAPI | Java SpringBoot |
|------|-------------|---------------|----------------|
| **UI æ¸²æŸ“** | âœ… ä¸»è´£ | âŒ | âŒ |
| **ç”¨æˆ·äº¤äº’** | âœ… ä¸»è´£ | âŒ | âŒ |
| **SSE æ¶ˆè´¹** | âœ… ä¸»è´£ | âŒ | âŒ |
| **çŠ¶æ€ç®¡ç†** | âœ… ä¸»è´£ (å®¢æˆ·ç«¯) | ğŸŸ¡ è¾…åŠ© (æœåŠ¡ç«¯ç¼“å­˜) | âŒ |
| **æ„å›¾ç†è§£** | âŒ | âœ… ä¸»è´£ (RouterAgent) | âŒ |
| **Blueprint ç”Ÿæˆ** | âŒ | âœ… ä¸»è´£ (PlannerAgent) | âŒ |
| **é¡µé¢ç¼–æ’** | âŒ | âœ… ä¸»è´£ (ExecutorAgent) | âŒ |
| **å®ä½“è§£æ** | âŒ | âœ… ä¸»è´£ (EntityResolver) | âŒ |
| **RAG æ£€ç´¢** | âŒ | âœ… ä¸»è´£ (RAG Service) | âŒ |
| **LLM è°ƒç”¨** | âŒ | âœ… ä¸»è´£ (PydanticAI) | âŒ |
| **æ•°æ®è·å–** | âŒ | ğŸŸ¡ è½¬å‘ (via Adapter) | âœ… ä¸»è´£ |
| **æ•°æ®æŒä¹…åŒ–** | âŒ | âŒ | âœ… ä¸»è´£ |
| **æƒé™éªŒè¯** | âŒ | ğŸŸ¡ è¾…åŠ© (ä¼ é€’ teacherId) | âœ… ä¸»è´£ |
| **ä¸šåŠ¡è§„åˆ™** | âŒ | âŒ | âœ… ä¸»è´£ |

---

### æ–¹æ¡ˆ 2: æ•°æ®å¥‘çº¦ç»Ÿä¸€åŒ–

#### 2.1 æ•°æ®æµè½¬å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Java Backend    â”‚
â”‚  (snake_case /   â”‚
â”‚   camelCase æ··åˆ) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTP Response: Result<T>
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Adapter å±‚       â”‚ â† Phase 5 å¼•å…¥ï¼Œéš”ç¦» Java DTO å˜åŒ–
â”‚  (Python)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Internal Data Model (ClassInfo, GradeData, ...)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tools å±‚         â”‚
â”‚  (FastMCP)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Tool Output (dict)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ExecutorAgent   â”‚
â”‚  (Phase C)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ SSE Events (BlockStartEvent, SlotDeltaEvent, ...)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CamelModel      â”‚ â† Phase 1 å¼•å…¥ï¼Œè‡ªåŠ¨ snake_case â†’ camelCase
â”‚  (Pydantic)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ JSON Response (camelCase)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend        â”‚
â”‚  (TypeScript)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.2 å…³é”®æ•°æ®æ¨¡å‹æ˜ å°„

| Java DTO | Internal Model (Python) | Frontend TypeScript |
|----------|------------------------|---------------------|
| `ClassroomDTO` | `ClassInfo(CamelModel)` | `interface ClassInfo` |
| `SubmissionDTO` | `SubmissionRecord(CamelModel)` | `interface SubmissionRecord` |
| `GradeHistoryItem` | `GradeRecord(CamelModel)` | `interface GradeRecord` |
| `Result<List<ClassroomDTO>>` | `list[ClassInfo]` | `ClassInfo[]` |

**å‘½åè§„èŒƒ**:
- Java DTO: `snake_case` æˆ– `camelCase` (é—ç•™æ··åˆ)
- Internal Model: `snake_case` (Python æ ‡å‡†)
- Frontend JSON: `camelCase` (è‡ªåŠ¨ç”± CamelModel åºåˆ—åŒ–)
- Frontend TypeScript: `camelCase` (interface å®šä¹‰)

#### 2.3 è‡ªåŠ¨ç”Ÿæˆ TypeScript ç±»å‹ (å»ºè®® Phase 6+)

**æ–¹æ¡ˆ**: ä½¿ç”¨ `pydantic-to-typescript` è‡ªåŠ¨ç”Ÿæˆ

```bash
# å®‰è£…å·¥å…·
pip install pydantic-to-typescript

# ç”Ÿæˆç±»å‹å®šä¹‰
pydantic2ts --module models.blueprint --output frontend/types/blueprint.ts
pydantic2ts --module models.conversation --output frontend/types/conversation.ts
pydantic2ts --module models.data --output frontend/types/data.ts
```

**ä¼˜åŠ¿**:
- âœ… æ¶ˆé™¤æ‰‹å†™ TypeScript ç±»å‹çš„ç»´æŠ¤æˆæœ¬
- âœ… ç¡®ä¿ Python â†” TypeScript ç±»å‹ä¸€è‡´æ€§
- âœ… Python æ¨¡å‹å˜æ›´åè‡ªåŠ¨åŒæ­¥

---

### æ–¹æ¡ˆ 3: ç»Ÿä¸€é”™è¯¯å¤„ç†é“¾è·¯

#### 3.1 é”™è¯¯æµè½¬å›¾

```mermaid
flowchart TD
    A[Java Backend Error] -->|HTTP Status Code| B{Adapter å±‚}
    B -->|404 Not Found| C[EntityNotFoundError]
    B -->|403 Forbidden| D[PermissionError]
    B -->|500 Server Error| E[DataFetchError]
    B -->|Network Timeout| F[Circuit Breaker]

    C -->|SSE Event| G[DATA_ERROR]
    D -->|SSE Event| H[ERROR: AUTH_ERROR]
    E -->|SSE Event| I[ERROR: DATA_ERROR]
    F -->|Fallback| J[Mock Data]

    G --> K[Frontend: æ˜¾ç¤ºå®ä½“ä¸å­˜åœ¨ + suggestions]
    H --> L[Frontend: é‡å®šå‘ç™»å½•]
    I --> M[Frontend: æ˜¾ç¤ºæ•°æ®è·å–å¤±è´¥]
    J --> N[Frontend: æ­£å¸¸æ¸²æŸ“ + æç¤ºæ¼”ç¤ºæ•°æ®]

    F -->|è¿ç»­5æ¬¡å¤±è´¥| O[Circuit OPEN]
    O -->|SSE Event| P[ERROR: SERVICE_UNAVAILABLE]
    P --> Q[Frontend: æ˜¾ç¤ºæœåŠ¡æš‚æ—¶ä¸å¯ç”¨]
```

#### 3.2 é”™è¯¯ç æ˜ å°„è¡¨

| åœºæ™¯ | Java é”™è¯¯ | Python å¼‚å¸¸ | SSE äº‹ä»¶ | å‰ç«¯å¤„ç† |
|------|-----------|-------------|----------|----------|
| **å®ä½“ä¸å­˜åœ¨** | 404 Not Found | `EntityNotFoundError` | `DATA_ERROR` | æ˜¾ç¤º "ç­çº§/å­¦ç”Ÿä¸å­˜åœ¨" + suggestions |
| **æƒé™ä¸è¶³** | 403 Forbidden | `PermissionError` | `ERROR` (code: `AUTH_ERROR`) | é‡å®šå‘ç™»å½•æˆ–æ˜¾ç¤ºæ— æƒé™æç¤º |
| **æœåŠ¡å™¨é”™è¯¯** | 500 Internal Error | `DataFetchError` | `ERROR` (code: `DATA_ERROR`) | æ˜¾ç¤º "æ•°æ®è·å–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•" |
| **ç½‘ç»œè¶…æ—¶** | Timeout | `httpx.TimeoutError` â†’ Circuit Breaker | (æ— é”™è¯¯ï¼Œé™çº§ mock) | æ­£å¸¸æ¸²æŸ“ + æç¤º "å½“å‰ä½¿ç”¨æ¼”ç¤ºæ•°æ®" |
| **ç†”æ–­å™¨æ‰“å¼€** | è¿ç»­ 5 æ¬¡å¤±è´¥ | `CircuitOpenError` | `ERROR` (code: `SERVICE_UNAVAILABLE`) | æ˜¾ç¤º "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢æ¼”ç¤ºæ¨¡å¼" |
| **å‚æ•°æ ¡éªŒå¤±è´¥** | 400 Bad Request | `ValidationError` | `ERROR` (code: `VALIDATION_ERROR`) | æ˜¾ç¤ºå…·ä½“å­—æ®µé”™è¯¯ä¿¡æ¯ |
| **LLM è°ƒç”¨å¤±è´¥** | N/A | `LLMError` | `ERROR` (code: `AI_ERROR`) | æ˜¾ç¤º "AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨" |
| **Blueprint è§£æå¤±è´¥** | N/A | `BlueprintValidationError` | `ERROR` (code: `BLUEPRINT_ERROR`) | æ˜¾ç¤º "ä»»åŠ¡è§„åˆ’å¤±è´¥ï¼Œè¯·é‡æ–°æè¿°" |

#### 3.3 SSE é”™è¯¯äº‹ä»¶æ ¼å¼

**æ ‡å‡† ERROR äº‹ä»¶**:
```json
{
  "type": "ERROR",
  "code": "DATA_ERROR | AUTH_ERROR | SERVICE_UNAVAILABLE | ...",
  "message": "ç”¨æˆ·å‹å¥½çš„é”™è¯¯æè¿°",
  "details": {
    "path": "/dify/teacher/t-001/classes/class-2c",
    "statusCode": 404,
    "timestamp": "2026-02-04T10:00:00Z"
  }
}
```

**DATA_ERROR äº‹ä»¶** (Phase 4.5 å¼•å…¥):
```json
{
  "type": "DATA_ERROR",
  "entity": "class-2c",
  "entityType": "class",
  "message": "ç­çº§ 2C ä¸å­˜åœ¨",
  "suggestions": [
    {"label": "1A ç­", "value": "class-1a"},
    {"label": "1B ç­", "value": "class-1b"}
  ]
}
```

---

### æ–¹æ¡ˆ 4: æ€§èƒ½ SLA å’Œç›‘æ§

#### 4.1 å“åº”æ—¶é—´ SLA

| ç«¯ç‚¹ | P50 | P90 | P99 | è¶…æ—¶é˜ˆå€¼ |
|------|-----|-----|-----|---------|
| `POST /api/conversation` (chat) | < 500ms | < 1s | < 2s | 5s |
| `POST /api/conversation` (build) | < 2s | < 5s | < 10s | 30s |
| `POST /api/page/generate` (SSE) | TTFB < 1s | å®Œæ•´æµ < 30s | å®Œæ•´æµ < 60s | 120s |
| `POST /api/page/patch` (layout) | < 200ms | < 500ms | < 1s | 2s |
| `POST /api/page/patch` (compose) | < 2s | < 5s | < 10s | 30s |
| Java API è°ƒç”¨ | < 100ms | < 300ms | < 500ms | 15s (å¯é…ç½®) |

**è¯´æ˜**:
- **TTFB** (Time To First Byte): SSE ç¬¬ä¸€ä¸ªäº‹ä»¶åˆ°è¾¾æ—¶é—´
- **P50/P90/P99**: ä¸­ä½æ•°/90åˆ†ä½/99åˆ†ä½å“åº”æ—¶é—´
- **è¶…æ—¶é˜ˆå€¼**: è§¦å‘ timeout é”™è¯¯çš„æ—¶é—´

#### 4.2 ç¼“å­˜ç­–ç•¥

| æ•°æ®ç±»å‹ | ç¼“å­˜ä½ç½® | ç¼“å­˜æ—¶é•¿ | å¤±æ•ˆç­–ç•¥ |
|---------|---------|---------|---------|
| **Blueprint** | å‰ç«¯ State | ä¼šè¯æœŸé—´ | ç”¨æˆ·åˆ·æ–°é¡µé¢ / rebuild |
| **Page** | å‰ç«¯ State | ä¼šè¯æœŸé—´ | ç”¨æˆ·åˆ·æ–°é¡µé¢ / refine / rebuild |
| **Data Context** | å‰ç«¯ State | ä¼šè¯æœŸé—´ | ç”¨æˆ·é‡æ–°é€‰æ‹©æ•°æ® |
| **Compute Results** | å‰ç«¯ State | ä¼šè¯æœŸé—´ | æ•°æ®å˜æ›´ |
| **Teacher Classes** | Python Memory | 5 åˆ†é’Ÿ | TTL è¿‡æœŸ / æ‰‹åŠ¨æ¸…é™¤ |
| **RAG æ£€ç´¢ç»“æœ** | Python Memory | 30 åˆ†é’Ÿ | TTL è¿‡æœŸ |
| **Rubric / çŸ¥è¯†ç‚¹** | Python Memory | æ°¸ä¹… (å¯åŠ¨æ—¶åŠ è½½) | åº”ç”¨é‡å¯ |

**è®¾è®¡åŸåˆ™**:
- âœ… **å‰ç«¯ä¼˜å…ˆç¼“å­˜**: Blueprint/Page/Context åœ¨å‰ç«¯ç¼“å­˜ï¼Œå‡å°‘ SSE é‡å»º
- âœ… **Python è¾…åŠ©ç¼“å­˜**: é«˜é¢‘æ•°æ® (Teacher Classes) çŸ­æ—¶ç¼“å­˜
- âœ… **Java æ— ç¼“å­˜**: Java åç«¯åªè´Ÿè´£æ•°æ®æŒä¹…åŒ–ï¼Œä¸åšç¼“å­˜

#### 4.3 å¹¶å‘æ§åˆ¶

| åœºæ™¯ | é™åˆ¶ç­–ç•¥ | è¯´æ˜ |
|------|---------|------|
| **å•ç”¨æˆ·å¹¶å‘è¯·æ±‚** | åŒä¸€ teacherId æœ€å¤š 3 ä¸ªå¹¶å‘ SSE æµ | é˜²æ­¢æ¶æ„å¹¶å‘ |
| **LLM å¹¶å‘è°ƒç”¨** | æ¯ä¸ª ExecutorAgent æœ€å¤š 5 ä¸ªå¹¶å‘ block ç”Ÿæˆ | é¿å… LLM API é™æµ |
| **Java API å¹¶å‘** | è¿æ¥æ±  50 è¿æ¥ (å¯é…ç½®) | httpx.AsyncClient è¿æ¥æ± ç®¡ç† |

---

### æ–¹æ¡ˆ 5: Phase 8 å‡çº§è·¯å¾„è§„åˆ’

#### 5.1 å‡çº§ç›®æ ‡

å°† RAG ä» "QuestionPipeline ä¸“ç”¨" å‡çº§ä¸º "é€šç”¨ Knowledge Layer"ï¼Œæ”¯æŒæ‰¹æ”¹ã€å¤‡è¯¾ç­‰åœºæ™¯ã€‚

#### 5.2 æ¶æ„å˜æ›´

**å½“å‰æ¶æ„ (Phase 7)**:
```
PlannerAgent â†’ Blueprint (DataContract only)
                   â†“
ExecutorAgent Phase A: Data Binding (è°ƒç”¨ data_tools)
                   â†“
ExecutorAgent Phase C: Compose (AI ç”Ÿæˆï¼Œæ— çŸ¥è¯†çº¦æŸ)

QuestionPipeline ä¸“ç”¨ RAG (ç¡¬ç¼–ç è°ƒç”¨)
```

**ç›®æ ‡æ¶æ„ (Phase 8)**:
```
PlannerAgent â†’ Blueprint (DataContract + KnowledgeContract)
                   â†“
ExecutorAgent Phase A: Input Binding (Data + Knowledge æ··åˆæ‹“æ‰‘æ’åº)
  â”œâ”€ DataBinding: è°ƒç”¨ data_tools (ç°æœ‰)
  â””â”€ KnowledgeBinding: è°ƒç”¨ knowledge_tools (æ–°å¢)
                   â†“
ExecutorAgent Phase C: Compose (æ³¨å…¥ data_context + knowledge_context)
  â”œâ”€ template_tools çº¦æŸè¾“å‡ºæ ¼å¼
  â””â”€ ä½¿ç”¨æ··åˆä¸Šä¸‹æ–‡æ„å»º prompt

é€šç”¨ QualityPipeline åŸºç±»
  â”œâ”€ QuestionQualityPipeline (å‡ºé¢˜)
  â”œâ”€ GradingQualityPipeline (æ‰¹æ”¹)
  â””â”€ LessonQualityPipeline (å¤‡è¯¾)
```

#### 5.3 å¹³æ»‘å‡çº§æ­¥éª¤

**é˜¶æ®µ 1: æ¨¡å‹æ‰©å±•** (ä¸ç ´åç°æœ‰åŠŸèƒ½)
- [x] Phase 7: `models/rubric.py` + `models/question_pipeline.py` (å·²å®Œæˆ)
- [ ] Phase 8.1: `models/blueprint.py` æ–°å¢ `KnowledgeBinding` ç±»
- [ ] Phase 8.1: `DataContract` æ–°å¢ `knowledge_bindings: list[KnowledgeBinding]`

**é˜¶æ®µ 2: å·¥å…·å±‚æ‰©å±•** (å‘åå…¼å®¹)
- [ ] Phase 8.2: `tools/knowledge_tools.py` æ–°å¢ 4 ä¸ª RAG æ£€ç´¢å·¥å…·
- [ ] Phase 8.2: `tools/template_tools.py` æ–°å¢ 3 ä¸ªæ¨¡æ¿å·¥å…·
- [ ] Phase 8.2: ç°æœ‰ `data_tools.py` ä¿æŒä¸å˜

**é˜¶æ®µ 3: Executor æ¸è¿›å¼å‡çº§** (Feature Flag æ§åˆ¶)
- [ ] Phase 8.3: Executor Phase A æ–°å¢ `_resolve_knowledge_bindings()` (ä¸ `_resolve_data_bindings()` å¹¶è¡Œ)
- [ ] Phase 8.3: Feature Flag `ENABLE_KNOWLEDGE_BINDING` æ§åˆ¶æ˜¯å¦æ‰§è¡Œ Knowledge Binding
- [ ] Phase 8.3: Phase C Compose æ³¨å…¥ `knowledge_context` (å‘åå…¼å®¹ï¼Œæ—  knowledge æ—¶ä¸ºç©º dict)

**é˜¶æ®µ 4: PlannerAgent æ¸è¿›å¼å‡çº§** (æŒ‰åœºæ™¯åˆ†æµ)
- [ ] Phase 8.4: Planner System Prompt æ³¨å…¥ `knowledge_tools` æè¿°
- [ ] Phase 8.4: Planner æŒ‰ task_type å†³å®šæ˜¯å¦ç”Ÿæˆ `knowledge_bindings`:
  - `task_type == "question_generation"` â†’ ç”Ÿæˆ knowledge_bindings (æ£€ç´¢é¢˜åº“ã€çŸ¥è¯†ç‚¹)
  - `task_type == "grading"` â†’ ç”Ÿæˆ knowledge_bindings (æ£€ç´¢ rubric anchorsã€æ ¡å†…è§„èŒƒ)
  - `task_type == "lesson_planning"` â†’ ç”Ÿæˆ knowledge_bindings (æ£€ç´¢æ•™æ¡ˆæ¡†æ¶ã€æ•™æ)
  - `task_type == "data_analysis"` â†’ ä¸ç”Ÿæˆ knowledge_bindings (ç°æœ‰è·¯å¾„)

**é˜¶æ®µ 5: å…¨é‡éªŒè¯** (E2E æµ‹è¯•)
- [ ] Phase 8.5: æ‰¹æ”¹åœºæ™¯ E2E æµ‹è¯• (å« knowledge_bindings)
- [ ] Phase 8.5: å¤‡è¯¾åœºæ™¯ E2E æµ‹è¯• (å« knowledge_bindings)
- [ ] Phase 8.5: æ•°æ®åˆ†æåœºæ™¯å›å½’æµ‹è¯• (æ—  knowledge_bindingsï¼Œç¡®ä¿ä¸å—å½±å“)

**å›æ»šç­–ç•¥**:
- Feature Flag `ENABLE_KNOWLEDGE_BINDING=false` å®Œå…¨ç¦ç”¨ Phase 8 åŠŸèƒ½
- Planner å³ä½¿ç”Ÿæˆäº† `knowledge_bindings`ï¼ŒExecutor ä¹Ÿä¼šè·³è¿‡ (Feature Flag æ§åˆ¶)
- å‰ç«¯æ— éœ€ä»»ä½•å˜æ›´ (Blueprint å¯¹å‰ç«¯ä¸é€æ˜)

---

## å®æ–½ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ (Phase 6 å¿…é¡»)

| ä»»åŠ¡ | è´Ÿè´£æ–¹ | é¢„è®¡å·¥ä½œé‡ |
|------|--------|-----------|
| **å‰ç«¯ Next.js Proxy å®ç°** | å‰ç«¯å›¢é˜Ÿ | 3-5 å¤© |
| **å‰ç«¯ SSE æ¶ˆè´¹å®ç°** | å‰ç«¯å›¢é˜Ÿ | 5-7 å¤© |
| **å‰ç«¯ 6 ç§ Block ç»„ä»¶æ¸²æŸ“** | å‰ç«¯å›¢é˜Ÿ | 7-10 å¤© |
| **å‰ç«¯é”™è¯¯å¤„ç† (ERROR/DATA_ERROR)** | å‰ç«¯å›¢é˜Ÿ | 2-3 å¤© |
| **TypeScript ç±»å‹å®šä¹‰** | å‰ç«¯å›¢é˜Ÿ (æ‰‹å†™) / Python å›¢é˜Ÿ (è‡ªåŠ¨ç”Ÿæˆ) | 3-5 å¤© |
| **Python æ€§èƒ½ç›‘æ§åŸ‹ç‚¹** | Python å›¢é˜Ÿ | 2-3 å¤© |
| **Java API å“åº”æ—¶é—´ä¼˜åŒ–** | Java å›¢é˜Ÿ | 3-5 å¤© (å¦‚æœ‰éœ€è¦) |

### ä¸­ä¼˜å…ˆçº§ (Phase 6+)

| ä»»åŠ¡ | è´Ÿè´£æ–¹ | é¢„è®¡å·¥ä½œé‡ |
|------|--------|-----------|
| **è‡ªåŠ¨ç”Ÿæˆ TypeScript ç±»å‹** | Python å›¢é˜Ÿ + å‰ç«¯å›¢é˜Ÿ | 2-3 å¤© (é›†æˆ CI/CD) |
| **API ç‰ˆæœ¬ç®¡ç†æœºåˆ¶** | ä¸‰æ–¹åå•† | 3-5 å¤© (è®¾è®¡ + å®æ–½) |
| **å‰ç«¯ç¼“å­˜ç­–ç•¥å®ç°** | å‰ç«¯å›¢é˜Ÿ | 2-3 å¤© |
| **Python ç¼“å­˜å±‚å®ç°** | Python å›¢é˜Ÿ | 2-3 å¤© (Redis æˆ–å†…å­˜ç¼“å­˜) |
| **ç›‘æ§ Dashboard** | DevOps å›¢é˜Ÿ | 5-7 å¤© (Grafana + Prometheus) |

### ä½ä¼˜å…ˆçº§ (Phase 8)

| ä»»åŠ¡ | è´Ÿè´£æ–¹ | é¢„è®¡å·¥ä½œé‡ |
|------|--------|-----------|
| **Phase 8 æ¶æ„å‡çº§** | Python å›¢é˜Ÿ | è§ [Phase 8 å®æ–½è·¯çº¿å›¾](../roadmap.md#phase-8) |
| **é€šç”¨çŸ¥è¯†å±‚ E2E æµ‹è¯•** | Python å›¢é˜Ÿ | 5-7 å¤© |

---

## é™„å½•

### A. å…³é”®å†³ç­–è®°å½•

| å†³ç­– | ç†ç”± | æ›¿ä»£æ–¹æ¡ˆ |
|------|------|---------|
| **å‰ç«¯ç¦æ­¢ç›´è°ƒ Java API** | é¿å…å‰ç«¯ç›´æ¥ä¾èµ– Java åç«¯å˜åŒ–ï¼Œç»Ÿä¸€ç”± Python ç¼–æ’å±‚å¤„ç†å®ä½“è§£æã€æƒé™ã€é”™è¯¯ | å‰ç«¯ç›´è°ƒ Java + Python åªåš AI ç¼–æ’ (å¢åŠ å‰ç«¯å¤æ‚åº¦) |
| **Adapter å±‚éš”ç¦» Java DTO** | Java API æ ¼å¼å˜åŒ–æ—¶åªéœ€ä¿®æ”¹ Adapterï¼Œä¸å½±å“ Tools/Agents/Frontend | ç›´æ¥æš´éœ² Java DTO åˆ°å·¥å…·å±‚ (è€¦åˆåº¦é«˜) |
| **CamelModel è‡ªåŠ¨åºåˆ—åŒ–** | ç»Ÿä¸€ Python (snake_case) å’Œ Frontend (camelCase) å‘½åé£æ ¼ | æ‰‹åŠ¨è½¬æ¢æ¯ä¸ªå­—æ®µ (ç»´æŠ¤æˆæœ¬é«˜) |
| **SSE é€ block æµå¼è¾“å‡º** | å‰ç«¯å¯å®æ—¶æ¸²æŸ“ï¼Œæå‡ç”¨æˆ·ä½“éªŒ (æ‰“å­—æœºæ•ˆæœ) | ä¸€æ¬¡æ€§è¿”å›å®Œæ•´é¡µé¢ (ç”¨æˆ·ç­‰å¾…æ—¶é—´é•¿) |
| **Patch æœºåˆ¶åˆ†æµ** | å¾®è°ƒæ—¶é¿å…å…¨é¡µé‡å»ºï¼Œå‡å°‘ LLM è°ƒç”¨æˆæœ¬å’Œç­‰å¾…æ—¶é—´ | æ¯æ¬¡ refine éƒ½å®Œæ•´é‡å»º (æˆæœ¬é«˜) |
| **Phase 8 Feature Flag æ¸è¿›å¼å‡çº§** | é™ä½å‡çº§é£é™©ï¼Œå¯å¿«é€Ÿå›æ»š | ä¸€æ¬¡æ€§å…¨é‡å‡çº§ (é£é™©é«˜) |

### B. å‚è€ƒæ–‡æ¡£

- [åç«¯æµç¨‹å›¾](backend-flow.md)
- [æ¶æ„æ€»è§ˆ](overview.md)
- [å‰ç«¯é›†æˆè§„èŒƒ](../integration/frontend-integration.md)
- [Java åç«¯å¯¹æ¥](../integration/java-backend.md)
- [SSE åè®®](../api/sse-protocol.md)
- [å®æ–½è·¯çº¿å›¾](../roadmap.md)

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Python åç«¯å›¢é˜Ÿ
**æœ€åæ›´æ–°**: 2026-02-04
**å˜æ›´å†å²**:
- 2026-02-04: åˆç‰ˆå‘å¸ƒ (åŸºäº Phase 7 å®ŒæˆçŠ¶æ€)
